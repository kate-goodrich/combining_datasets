BootStrap: docker
From: rocker/geospatial:latest

%post
    # Update package list
    apt-get update

    # Install locales and generate the necessary locale
    apt-get install -y locales
    locale-gen en_US.UTF-8

    # Install fonts for Unicode support
    apt-get install -y fonts-dejavu fonts-liberation fonts-noto fonts-unifont

    # Install SSL certificates and curl for downloading data
    apt-get install -y \
        libcurl4-openssl-dev \
        libssl-dev \
        ca-certificates \
        curl \
        slurm-client

    # Install git-lfs for debugging and versioning
    apt-get install -y git-lfs && git lfs install

    # Install tools for extracting 7z archives and geospatial processing
    apt-get install -y \
        p7zip-full \
        gdal-bin \
        libgdal-dev \
        libudunits2-dev \
        libgeos-dev \
        libproj-dev \
        libxml2-dev

    # Clean up APT cache to reduce image size
    apt-get clean

    # Set locale for the environment
    echo "LANG=en_US.UTF-8" >> /etc/default/locale
    echo "LC_ALL=en_US.UTF-8" >> /etc/default/locale
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8

    # Create directories
    mkdir -p /pipeline /input /opt/_targets /project /data /scratch

    # Install R packages
    Rscript -e "install.packages(c(
      'pak', 'devtools', 'tarchetypes', 'testthat', 'tidymodels',
      'bonsai', 'qs', 'qs2', 'kernlab', 'lightgbm', 'lwgeom', 'doRNG', 'quarto',
      'sf', 'terra', 'raster', 'ncdf4', 'dplyr', 'tidyr', 'archive',
      'languageserver', 'amadeus'
    ))"

    Rscript -e "pak::pak('NIEHS/amadeus')"

    Rscript -e "devtools::install_version('targets', version = '1.10.0')"

    apt-get update && apt-get install -y libicu-dev


# Fix curl certificate issue
apt-get install -y ca-certificates
update-ca-certificates



%environment
    export LANG=en_US.UTF-8
    export LC_ALL=en_US.UTF-8
    export TERM=xterm-256color
    export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
    export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt

%runscript
    echo "Use apptainer exec ... R or Rscript inside this container."

%labels
    Author="Kate"
    Description="Geospatial container with R, MODIS tools, Unicode text, and 7z extraction support."
