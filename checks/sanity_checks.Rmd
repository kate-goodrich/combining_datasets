---
title: "Sanity Checks and Visualizations for Aggregated Amadeus Datasets"
output:
  github_document:
    toc: true
    toc_depth: 3
    html_preview: false   
---



# set container library
```{r}
# oppten apptainer in bash when running interactively
# apptainer shell /ddn/gs1/group/set/chords/combining_datasets/container_combining_datasets.sif

.libPaths("/usr/local/lib/R/site-library")

get_project_dir <- function() {
  from_env <- Sys.getenv("PROJECT_DIR", unset = NA)
  if (!is.na(from_env) && nzchar(from_env)) {
    return(normalizePath(from_env, mustWork = FALSE))
  }
  in_file <- tryCatch(knitr::current_input(), error = function(e) NULL)
  if (!is.null(in_file) && nzchar(in_file)) {
    return(normalizePath(dirname(in_file), mustWork = FALSE))
  }
  normalizePath(getwd(), mustWork = FALSE)
}

project_dir <- get_project_dir()
knitr::opts_knit$set(root.dir = project_dir)

# Headless-safe plotting
knitr::opts_chunk$set(dev = "ragg_png", dpi = 150)


# Keep ragg from interpreting huge inch sizes
options(ragg.max_dim = 10000)  # optional; with units="px" you shouldn't hit the cap

```

 # Load packages
```{r setup, include=FALSE}
library(arrow)
library(dplyr)
library(tidyverse)
library(sf)
library(cowplot)
library(ragg)     
library(gifski) 
```


# Load data
```{r}
#for interactive

# Resolve paths relative to root.dir set above
ds <- function(...) file.path(project_dir, ...)

county_annual  <- open_dataset(ds("handoffs/county_annual_long/county_annual.parquet"))
county_monthly <- open_dataset(ds("handoffs/county_monthly_long/county_monthly.parquet"))
tract_annual   <- open_dataset(ds("handoffs/tract_annual_long/tract_annual.parquet"))
tract_monthly  <- open_dataset(ds("handoffs/tract_monthly_long/tract_monthly.parquet"))
```



# County-Annual Sanity checks
```{r}
# check for duplicated geoid-year-variable combinations
anyDuplicated(county_annual[c("geoid", "year", "variable")])

# Basic shape
# should be 3144 counties, 17 years (2010-2024) normal and static, 148 vars
county_annual %>%
  summarise(
    n_rows     = n(),
    n_counties = n_distinct(geoid),
    n_years    = n_distinct(year),
    n_vars     = n_distinct(variable)
  ) %>%
  collect()

# List distinct years in the dataset
county_annual %>%
  distinct(year) %>%
  arrange(year) %>%
  collect()



var_summary <- county_annual %>%
  group_by(variable) %>%
  summarise(
    min_val   = min(value, na.rm = TRUE),
    max_val   = max(value, na.rm = TRUE),
    mean_val  = mean(value, na.rm = TRUE),
    median_val = median(value, na.rm = TRUE),
    sd_val    = sd(value, na.rm = TRUE)
  ) %>%
  arrange(variable) %>%
  collect()


# Expected ranges table
expected_ranges <- tribble(
  ~variable,                       ~min_exp,  ~max_exp,
  "aet",                           0,        250,
  "albedo",                        0,        0.9,
  "area_km2",                      5,        383000,
  "bcsmass",                       1e-11,    1e-8,
  "be30_grd",                      0,        6000,
  "cldtot",                        0,        1,
  "def",                           0,        340,
  "ds30_grd",                      0,        6000,
  "dusmass25",                     1e-11,    3e-8,
  "evi",                           -0.1,     1,
  "etr",                           0,        18,
  "evap",                          1e-8,     1e-4,
  "fractional_impervious_surface", 0,        100,
    "fractional_impervious_surface_mean", 0,        100,
  "grn",                           0,        1,
  "gwetroot",                      0,        1,
  "koppen_1",                      0,        1,
  "koppen_14",                     0,        1,
  "koppen_15",                     0,        1,
  "koppen_16",                     0,        1,
  "koppen_17",                     0,        1,
  "koppen_18",                     0,        1,
  "koppen_19",                     0,        1,
  "koppen_2",                      0,        1,
  "koppen_21",                     0,        1,
  "koppen_22",                     0,        1,
  "koppen_23",                     0,        1,
  "koppen_25",                     0,        1,
  "koppen_26",                     0,        1,
  "koppen_27",                     0,        1,
  "koppen_29",                     0,        1,
  "koppen_3",                      0,        1,
  "koppen_30",                     0,        1,
  "koppen_4",                      0,        1,
  "koppen_5",                      0,        1,
  "koppen_6",                      0,        1,
  "koppen_7",                      0,        1,
  "koppen_8",                      0,        1,
  "koppen_9",                      0,        1,
    "prop_cover_huc2_01",               0,       1,
  "prop_cover_huc2_02",               0,         1,
  "prop_cover_huc2_03",               0,         1,
  "prop_cover_huc2_04",               0,         1,
  "prop_cover_huc2_05",               0,         1,
  "prop_cover_huc2_06",               0,         1,
  "prop_cover_huc2_07",               0,         1,
  "prop_cover_huc2_08",               0,         1,
  "prop_cover_huc2_09",               0,         1,
  "prop_cover_huc2_10",               0,         1,
  "prop_cover_huc2_11",               0,         1,
  "prop_cover_huc2_12",               0,         1,
  "prop_cover_huc2_13",               0,         1,
  "prop_cover_huc2_14",               0,         1,
  "prop_cover_huc2_15",               0,         1,
  "prop_cover_huc2_16",               0,         1,
  "prop_cover_huc2_17",               0,         1,
  "prop_cover_huc2_18",               0,         1,
  "prop_cover_huc2_20",               0,         1,
  "prop_cover_huc2_21",               0,         1,
  "prop_cover_huc2_22",               0,         1,
  "koppen_confidence",             0,        100,
  "lai",                           0,        9,
 "land_cover_11",                 0,        1,
  "land_cover_12",                 0,        1,
  "land_cover_21",                 0,        1,
  "land_cover_22",                 0,        1,
  "land_cover_23",                 0,        1,
  "land_cover_24",                 0,        1,
  "land_cover_31",                 0,        1,
  "land_cover_41",                 0,        1,
  "land_cover_42",                 0,        1,
  "land_cover_43",                 0,        1,
  "land_cover_52",                 0,        1,
  "land_cover_71",                 0,        1,
  "land_cover_81",                 0,        1,
  "land_cover_82",                 0,        1,
  "land_cover_90",                 0,        1,
  "land_cover_95",                 0,        1,
  "land_cover_confidence",    0,        100,
  "land_cover_confidence_mean",    0,        100,
  "lst_day_1km_k",                 230,      400,
  "lst_night_1km_k",               230,      310,
  "lwgab",                         200,      400,
  "md30_grd",                      -400,     8850,
  "mi30_grd",                      -400,     8850,
  "mn30_grd",                      -400,     8850,
  "mx30_grd",                      0,        8850,
  "ndvi",                          -1,     1,
  "pblh",                          50,       2500,
  "pdsi",                          -10,       20,
  "pet",                           0,        350,
  "ppt",                           0,        1400,
  "pr",                            0,        50,
  "precsno",                       0,        7e-5,
  "prectotcorr",                   1e-7,     5e-4,
  "prop_heavy_coverage",           0,        1,
  "prop_light_coverage",           0,        1,
  "prop_med_coverage",             0,        1,
  "ps",                            50000,    105000,
  "qv2m",                          0,        0.04,
  "rmax",                          0,        100,
  "rmin",                          0,        100,
  "road_density_km_per_km2",       0,        9,
  "sd30_grd",                      0,        600,
  "slp",                           99000,    102500,
  "soil",                          0,        500,
  "solclear",                      2,        35,
  "solslope",                      0,        40,
  "soltotal",                      0,        32,
  "soltrans",                      0,        1,
  "sph",                           0,        0.03,
  "srad",                          0,        400,
  "sur_refl_b01",                  -.1,        1,
  "sur_refl_b02",                  0,        1,
  "sur_refl_b03",                  0,        1,
  "sur_refl_b04",                  0,        1,
  "sur_refl_b05",                  0,        1,
  "sur_refl_b06",                  0,        1,
  "sur_refl_b07",                  0,        1,
  "swe",                           0,        1300,
  "t2mdew",                        230,      350,
  "tdmean",                        -40,      27,
  "th",                            0,        360,
  "tmax",                          -50,      50,
  "tmean",                         -16,      40,
  "tmin",                          -60,      33,
  "tmmn",                          240,      350,
  "tmmx",                          240,      350,
  "annual_total_air_lb",                  0,        1e8,
  "annual_total_air_lb_per_km2",          0,        1e6,
  "annual_total_air_lb_plusbuffer",         0,        1e8,
  "annual_total_fugitive_air_lb",         0,        1e8,
  "annual_total_fugitive_air_lb_per_km2", 0,        5e5,
  "annual_total_fugitive_air_lb_plusbuffer",0,        1e8,
  "total_road_km",                 0,        6e4,
  "annual_total_stack_air_lb",            0,        1e8,
  "annual_total_stack_air_lb_per_km2",    0,        1e6,
  "annual_total_stack_air_lb_plusbuffer",   0,        1e8,
  "totexttau",                     0.02,     0.30,
  "ts",                            250,      305,
  "u10m",                          -20,      20,
  "vap",                           0,        5,
  "vpd",                           0,        6,
  "vpdmax",                        0,        80,
  "vpdmin",                        0,        30,
  "vs",                            0,        20,
  "ws",                            0,        14,
  "z0m",                           1e-4,     3,
  "tmin_norm",  -60,      30,
  "tmax_norm" ,  -50,      50,

)

# Compare observed vs expected
comparison <- var_summary %>%
  left_join(expected_ranges, by = "variable") %>%
  mutate(
    min_ok = min_val >= min_exp,
    max_ok = max_val <= max_exp,
    passes = ifelse(min_ok & max_ok, "Y", "N")
  ) %>%
  select(variable, min_val, max_val, min_exp, max_exp, passes)

print(comparison, n = Inf)




```






# County-Monthly Sanity checks
```{r}
# check for duplicated geoid-year-variable combinations
anyDuplicated(county_monthly[c("geoid", "year", "variable")])

# Basic shape
# should be 3144 counties, 17 years (2010-2024) normal and static, 148 vars
county_monthly %>%
  summarise(
    n_rows     = n(),
    n_counties = n_distinct(geoid),
    n_years    = n_distinct(year),
    n_vars     = n_distinct(variable)
  ) %>%
  collect()

# List distinct years and months in the dataset
county_monthly %>%
  distinct(year, month) %>%
  arrange(year, month) %>%
  collect() %>%
  print(n = Inf)



var_summary <- county_monthly %>%
  group_by(variable) %>%
  summarise(
    min_val   = min(value, na.rm = TRUE),
    max_val   = max(value, na.rm = TRUE),
    mean_val  = mean(value, na.rm = TRUE),
    median_val = median(value, na.rm = TRUE),
    sd_val    = sd(value, na.rm = TRUE)
  ) %>%
  arrange(variable) %>%
  collect()


# Compare observed vs expected
comparison <- var_summary %>%
  left_join(expected_ranges, by = "variable") %>%
  mutate(
    min_ok = min_val >= min_exp,
    max_ok = max_val <= max_exp,
    passes = ifelse(min_ok & max_ok, "Y", "N")
  ) %>%
  select(variable, min_val, max_val, min_exp, max_exp, passes)

print(comparison, n = Inf)

```


















# Tract-Annual Sanity checks
```{r}
# check for duplicated geoid-year-variable combinations
anyDuplicated(tract_annual[c("geoid", "year", "variable")])

# Basic shape
# should be over 84,119 counties, 17 years (2010-2024) normal and static, 148 vars
# 84119 census tracts - some may have had errors
tract_annual %>%
  summarise(
    n_rows     = n(),
    n_tracts = n_distinct(geoid),
    n_years    = n_distinct(year),
    n_vars     = n_distinct(variable)
  ) %>%
  collect()

# List distinct years in the dataset
tract_annual %>%
  distinct(year) %>%
  arrange(year) %>%
  collect()


var_summary <- tract_annual %>%
  group_by(variable) %>%
  summarise(
    min_val   = min(value, na.rm = TRUE),
    max_val   = max(value, na.rm = TRUE),
    mean_val  = mean(value, na.rm = TRUE),
    median_val = median(value, na.rm = TRUE),
    sd_val    = sd(value, na.rm = TRUE)
  ) %>%
  arrange(variable) %>%
  collect()




# Compare observed vs expected
comparison <- var_summary %>%
  left_join(expected_ranges, by = "variable") %>%
  mutate(
    min_ok = min_val >= min_exp,
    max_ok = max_val <= max_exp,
    passes = ifelse(min_ok & max_ok, "Y", "N")
  ) %>%
  select(variable, min_val, max_val, min_exp, max_exp, passes)

print(comparison, n = Inf)

```







# Tract-Monthly Sanity checks
```{r}
# check for duplicated geoid-year-variable combinations
anyDuplicated(tract_monthly[c("geoid", "year", "variable")])

# Basic shape
# should be over 84,414 counties, 17 years (2010-2024) normal and static, 140 vars
# 84119 census tracts - some may have had errors

tract_monthly %>%
  summarise(
    n_rows     = n(),
    n_tracts = n_distinct(geoid),
    n_years    = n_distinct(year),
    n_vars     = n_distinct(variable)
  ) %>%
  collect()


# List distinct years in the dataset
tract_monthly %>%
  distinct(year, month) %>%
  arrange(year, month) %>%
  collect() %>%
  print(n = Inf)



var_summary <- tract_monthly %>%
  group_by(variable) %>%
  summarise(
    min_val   = min(value, na.rm = TRUE),
    max_val   = max(value, na.rm = TRUE),
    mean_val  = mean(value, na.rm = TRUE),
    median_val = median(value, na.rm = TRUE),
    sd_val    = sd(value, na.rm = TRUE)
  ) %>%
  arrange(variable) %>%
  collect()

# Compare observed vs expected
comparison <- var_summary %>%
  left_join(expected_ranges, by = "variable") %>%
  mutate(
    min_ok = min_val >= min_exp,
    max_ok = max_val <= max_exp,
    passes = ifelse(min_ok & max_ok, "Y", "N")
  ) %>%
  select(variable, min_val, max_val, min_exp, max_exp, passes)

print(comparison, n = Inf)
```

