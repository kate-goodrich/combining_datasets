<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<style type="text/css">
@font-face {
font-family: octicons-link;
src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAZwABAAAAAACFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU0lHAAAGaAAAAAgAAAAIAAAAAUdTVUIAAAZcAAAACgAAAAoAAQAAT1MvMgAAAyQAAABJAAAAYFYEU3RjbWFwAAADcAAAAEUAAACAAJThvmN2dCAAAATkAAAABAAAAAQAAAAAZnBnbQAAA7gAAACyAAABCUM+8IhnYXNwAAAGTAAAABAAAAAQABoAI2dseWYAAAFsAAABPAAAAZwcEq9taGVhZAAAAsgAAAA0AAAANgh4a91oaGVhAAADCAAAABoAAAAkCA8DRGhtdHgAAAL8AAAADAAAAAwGAACfbG9jYQAAAsAAAAAIAAAACABiATBtYXhwAAACqAAAABgAAAAgAA8ASm5hbWUAAAToAAABQgAAAlXu73sOcG9zdAAABiwAAAAeAAAAME3QpOBwcmVwAAAEbAAAAHYAAAB/aFGpk3jaTY6xa8JAGMW/O62BDi0tJLYQincXEypYIiGJjSgHniQ6umTsUEyLm5BV6NDBP8Tpts6F0v+k/0an2i+itHDw3v2+9+DBKTzsJNnWJNTgHEy4BgG3EMI9DCEDOGEXzDADU5hBKMIgNPZqoD3SilVaXZCER3/I7AtxEJLtzzuZfI+VVkprxTlXShWKb3TBecG11rwoNlmmn1P2WYcJczl32etSpKnziC7lQyWe1smVPy/Lt7Kc+0vWY/gAgIIEqAN9we0pwKXreiMasxvabDQMM4riO+qxM2ogwDGOZTXxwxDiycQIcoYFBLj5K3EIaSctAq2kTYiw+ymhce7vwM9jSqO8JyVd5RH9gyTt2+J/yUmYlIR0s04n6+7Vm1ozezUeLEaUjhaDSuXHwVRgvLJn1tQ7xiuVv/ocTRF42mNgZGBgYGbwZOBiAAFGJBIMAAizAFoAAABiAGIAznjaY2BkYGAA4in8zwXi+W2+MjCzMIDApSwvXzC97Z4Ig8N/BxYGZgcgl52BCSQKAA3jCV8CAABfAAAAAAQAAEB42mNgZGBg4f3vACQZQABIMjKgAmYAKEgBXgAAeNpjYGY6wTiBgZWBg2kmUxoDA4MPhGZMYzBi1AHygVLYQUCaawqDA4PChxhmh/8ODDEsvAwHgMKMIDnGL0x7gJQCAwMAJd4MFwAAAHjaY2BgYGaA4DAGRgYQkAHyGMF8NgYrIM3JIAGVYYDT+AEjAwuDFpBmA9KMDEwMCh9i/v8H8sH0/4dQc1iAmAkALaUKLgAAAHjaTY9LDsIgEIbtgqHUPpDi3gPoBVyRTmTddOmqTXThEXqrob2gQ1FjwpDvfwCBdmdXC5AVKFu3e5MfNFJ29KTQT48Ob9/lqYwOGZxeUelN2U2R6+cArgtCJpauW7UQBqnFkUsjAY/kOU1cP+DAgvxwn1chZDwUbd6CFimGXwzwF6tPbFIcjEl+vvmM/byA48e6tWrKArm4ZJlCbdsrxksL1AwWn/yBSJKpYbq8AXaaTb8AAHja28jAwOC00ZrBeQNDQOWO//sdBBgYGRiYWYAEELEwMTE4uzo5Zzo5b2BxdnFOcALxNjA6b2ByTswC8jYwg0VlNuoCTWAMqNzMzsoK1rEhNqByEyerg5PMJlYuVueETKcd/89uBpnpvIEVomeHLoMsAAe1Id4AAAAAAAB42oWQT07CQBTGv0JBhagk7HQzKxca2sJCE1hDt4QF+9JOS0nbaaYDCQfwCJ7Au3AHj+LO13FMmm6cl7785vven0kBjHCBhfpYuNa5Ph1c0e2Xu3jEvWG7UdPDLZ4N92nOm+EBXuAbHmIMSRMs+4aUEd4Nd3CHD8NdvOLTsA2GL8M9PODbcL+hD7C1xoaHeLJSEao0FEW14ckxC+TU8TxvsY6X0eLPmRhry2WVioLpkrbp84LLQPGI7c6sOiUzpWIWS5GzlSgUzzLBSikOPFTOXqly7rqx0Z1Q5BAIoZBSFihQYQOOBEdkCOgXTOHA07HAGjGWiIjaPZNW13/+lm6S9FT7rLHFJ6fQbkATOG1j2OFMucKJJsxIVfQORl+9Jyda6Sl1dUYhSCm1dyClfoeDve4qMYdLEbfqHf3O/AdDumsjAAB42mNgYoAAZQYjBmyAGYQZmdhL8zLdDEydARfoAqIAAAABAAMABwAKABMAB///AA8AAQAAAAAAAAAAAAAAAAABAAAAAA==) format('woff');
}
body {
-webkit-text-size-adjust: 100%;
text-size-adjust: 100%;
color: #333;
font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
font-size: 16px;
line-height: 1.6;
word-wrap: break-word;
}
a {
background-color: transparent;
}
a:active,
a:hover {
outline: 0;
}
strong {
font-weight: bold;
}
h1 {
font-size: 2em;
margin: 0.67em 0;
}
img {
border: 0;
}
hr {
box-sizing: content-box;
height: 0;
}
pre {
overflow: auto;
}
code,
kbd,
pre {
font-family: monospace, monospace;
font-size: 1em;
}
input {
color: inherit;
font: inherit;
margin: 0;
}
html input[disabled] {
cursor: default;
}
input {
line-height: normal;
}
input[type="checkbox"] {
box-sizing: border-box;
padding: 0;
}
table {
border-collapse: collapse;
border-spacing: 0;
}
td,
th {
padding: 0;
}
* {
box-sizing: border-box;
}
input {
font: 13px / 1.4 Helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a {
color: #4078c0;
text-decoration: none;
}
a:hover,
a:active {
text-decoration: underline;
}
hr {
height: 0;
margin: 15px 0;
overflow: hidden;
background: transparent;
border: 0;
border-bottom: 1px solid #ddd;
}
hr:before {
display: table;
content: "";
}
hr:after {
display: table;
clear: both;
content: "";
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 15px;
margin-bottom: 15px;
line-height: 1.1;
}
h1 {
font-size: 30px;
}
h2 {
font-size: 21px;
}
h3 {
font-size: 16px;
}
h4 {
font-size: 14px;
}
h5 {
font-size: 12px;
}
h6 {
font-size: 11px;
}
blockquote {
margin: 0;
}
ul,
ol {
padding: 0;
margin-top: 0;
margin-bottom: 0;
}
ol ol,
ul ol {
list-style-type: lower-roman;
}
ul ul ol,
ul ol ol,
ol ul ol,
ol ol ol {
list-style-type: lower-alpha;
}
dd {
margin-left: 0;
}
code {
font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
font-size: 12px;
}
pre {
margin-top: 0;
margin-bottom: 0;
font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}
.select::-ms-expand {
opacity: 0;
}
.octicon {
font: normal normal normal 16px/1 octicons-link;
display: inline-block;
text-decoration: none;
text-rendering: auto;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
.octicon-link:before {
content: '\f05c';
}
.markdown-body:before {
display: table;
content: "";
}
.markdown-body:after {
display: table;
clear: both;
content: "";
}
.markdown-body>*:first-child {
margin-top: 0 !important;
}
.markdown-body>*:last-child {
margin-bottom: 0 !important;
}
a:not([href]) {
color: inherit;
text-decoration: none;
}
.anchor {
display: inline-block;
padding-right: 2px;
margin-left: -18px;
}
.anchor:focus {
outline: none;
}
h1,
h2,
h3,
h4,
h5,
h6 {
margin-top: 1em;
margin-bottom: 16px;
font-weight: bold;
line-height: 1.4;
}
h1 .octicon-link,
h2 .octicon-link,
h3 .octicon-link,
h4 .octicon-link,
h5 .octicon-link,
h6 .octicon-link {
color: #000;
vertical-align: middle;
visibility: hidden;
}
h1:hover .anchor,
h2:hover .anchor,
h3:hover .anchor,
h4:hover .anchor,
h5:hover .anchor,
h6:hover .anchor {
text-decoration: none;
}
h1:hover .anchor .octicon-link,
h2:hover .anchor .octicon-link,
h3:hover .anchor .octicon-link,
h4:hover .anchor .octicon-link,
h5:hover .anchor .octicon-link,
h6:hover .anchor .octicon-link {
visibility: visible;
}
h1 {
padding-bottom: 0.3em;
font-size: 2.25em;
line-height: 1.2;
border-bottom: 1px solid #eee;
}
h1 .anchor {
line-height: 1;
}
h2 {
padding-bottom: 0.3em;
font-size: 1.75em;
line-height: 1.225;
border-bottom: 1px solid #eee;
}
h2 .anchor {
line-height: 1;
}
h3 {
font-size: 1.5em;
line-height: 1.43;
}
h3 .anchor {
line-height: 1.2;
}
h4 {
font-size: 1.25em;
}
h4 .anchor {
line-height: 1.2;
}
h5 {
font-size: 1em;
}
h5 .anchor {
line-height: 1.1;
}
h6 {
font-size: 1em;
color: #777;
}
h6 .anchor {
line-height: 1.1;
}
p,
blockquote,
ul,
ol,
dl,
table,
pre {
margin-top: 0;
margin-bottom: 16px;
}
hr {
height: 4px;
padding: 0;
margin: 16px 0;
background-color: #e7e7e7;
border: 0 none;
}
ul,
ol {
padding-left: 2em;
}
ul ul,
ul ol,
ol ol,
ol ul {
margin-top: 0;
margin-bottom: 0;
}
li>p {
margin-top: 16px;
}
dl {
padding: 0;
}
dl dt {
padding: 0;
margin-top: 16px;
font-size: 1em;
font-style: italic;
font-weight: bold;
}
dl dd {
padding: 0 16px;
margin-bottom: 16px;
}
blockquote {
padding: 0 15px;
color: #777;
border-left: 4px solid #ddd;
}
blockquote>:first-child {
margin-top: 0;
}
blockquote>:last-child {
margin-bottom: 0;
}
table {
display: block;
width: 100%;
overflow: auto;
word-break: normal;
word-break: keep-all;
}
table th {
font-weight: bold;
}
table th,
table td {
padding: 6px 13px;
border: 1px solid #ddd;
}
table tr {
background-color: #fff;
border-top: 1px solid #ccc;
}
table tr:nth-child(2n) {
background-color: #f8f8f8;
}
img {
max-width: 100%;
box-sizing: content-box;
background-color: #fff;
}
code {
padding: 0;
padding-top: 0.2em;
padding-bottom: 0.2em;
margin: 0;
font-size: 85%;
background-color: rgba(0,0,0,0.04);
border-radius: 3px;
}
code:before,
code:after {
letter-spacing: -0.2em;
content: "\00a0";
}
pre>code {
padding: 0;
margin: 0;
font-size: 100%;
word-break: normal;
white-space: pre;
background: transparent;
border: 0;
}
.highlight {
margin-bottom: 16px;
}
.highlight pre,
pre {
padding: 16px;
overflow: auto;
font-size: 85%;
line-height: 1.45;
background-color: #f7f7f7;
border-radius: 3px;
}
.highlight pre {
margin-bottom: 0;
word-break: normal;
}
pre {
word-wrap: normal;
}
pre code {
display: inline;
max-width: initial;
padding: 0;
margin: 0;
overflow: initial;
line-height: inherit;
word-wrap: normal;
background-color: transparent;
border: 0;
}
pre code:before,
pre code:after {
content: normal;
}
kbd {
display: inline-block;
padding: 3px 5px;
font-size: 11px;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.pl-c {
color: #969896;
}
.pl-c1,
.pl-s .pl-v {
color: #0086b3;
}
.pl-e,
.pl-en {
color: #795da3;
}
.pl-s .pl-s1,
.pl-smi {
color: #333;
}
.pl-ent {
color: #63a35c;
}
.pl-k {
color: #a71d5d;
}
.pl-pds,
.pl-s,
.pl-s .pl-pse .pl-s1,
.pl-sr,
.pl-sr .pl-cce,
.pl-sr .pl-sra,
.pl-sr .pl-sre {
color: #183691;
}
.pl-v {
color: #ed6a43;
}
.pl-id {
color: #b52a1d;
}
.pl-ii {
background-color: #b52a1d;
color: #f8f8f8;
}
.pl-sr .pl-cce {
color: #63a35c;
font-weight: bold;
}
.pl-ml {
color: #693a17;
}
.pl-mh,
.pl-mh .pl-en,
.pl-ms {
color: #1d3e81;
font-weight: bold;
}
.pl-mq {
color: #008080;
}
.pl-mi {
color: #333;
font-style: italic;
}
.pl-mb {
color: #333;
font-weight: bold;
}
.pl-md {
background-color: #ffecec;
color: #bd2c00;
}
.pl-mi1 {
background-color: #eaffea;
color: #55a532;
}
.pl-mdr {
color: #795da3;
font-weight: bold;
}
.pl-mo {
color: #1d3e81;
}
kbd {
display: inline-block;
padding: 3px 5px;
font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
line-height: 10px;
color: #555;
vertical-align: middle;
background-color: #fcfcfc;
border: solid 1px #ccc;
border-bottom-color: #bbb;
border-radius: 3px;
box-shadow: inset 0 -1px 0 #bbb;
}
.task-list-item {
list-style-type: none;
}
.task-list-item+.task-list-item {
margin-top: 3px;
}
.task-list-item input {
margin: 0 0.35em 0.25em -1.6em;
vertical-align: middle;
}
:checked+.radio-label {
z-index: 1;
position: relative;
border-color: #4078c0;
}
.sourceLine {
display: inline-block;
}
code .kw { color: #000000; }
code .dt { color: #ed6a43; }
code .dv { color: #009999; }
code .bn { color: #009999; }
code .fl { color: #009999; }
code .ch { color: #009999; }
code .st { color: #183691; }
code .co { color: #969896; }
code .ot { color: #0086b3; }
code .al { color: #a61717; }
code .fu { color: #63a35c; }
code .er { color: #a61717; background-color: #e3d2d2; }
code .wa { color: #000000; }
code .cn { color: #008080; }
code .sc { color: #008080; }
code .vs { color: #183691; }
code .ss { color: #183691; }
code .im { color: #000000; }
code .va {color: #008080; }
code .cf { color: #000000; }
code .op { color: #000000; }
code .bu { color: #000000; }
code .ex { color: #000000; }
code .pp { color: #999999; }
code .at { color: #008080; }
code .do { color: #969896; }
code .an { color: #008080; }
code .cv { color: #008080; }
code .in { color: #008080; }
</style>
<style>
body {
box-sizing: border-box;
min-width: 200px;
max-width: 980px;
margin: 0 auto;
padding: 45px;
padding-top: 0px;
}
</style>


</head>

<body>

<h1 id="sanity-checks-and-visualizations-for-aggregated-amadeus-datasets">Sanity
Checks and Visualizations for Aggregated Amadeus Datasets</h1>
<h1 id="set-container-library">set container library</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># oppten apptainer in bash first</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># apptainer shell /ddn/gs1/group/set/chords/combining_datasets/container_combining_datasets.sif</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">.libPaths</span>(<span class="st">&quot;/usr/local/lib/R/site-library&quot;</span>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>get_project_dir <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  from_env <span class="ot">&lt;-</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;PROJECT_DIR&quot;</span>, <span class="at">unset =</span> <span class="cn">NA</span>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(from_env) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(from_env)) {</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">normalizePath</span>(from_env, <span class="at">mustWork =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  }</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  in_file <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(knitr<span class="sc">::</span><span class="fu">current_input</span>(), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(in_file) <span class="sc">&amp;&amp;</span> <span class="fu">nzchar</span>(in_file)) {</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">normalizePath</span>(<span class="fu">dirname</span>(in_file), <span class="at">mustWork =</span> <span class="cn">FALSE</span>))</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  }</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="fu">normalizePath</span>(<span class="fu">getwd</span>(), <span class="at">mustWork =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>project_dir <span class="ot">&lt;-</span> <span class="fu">get_project_dir</span>()</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>knitr<span class="sc">::</span>opts_knit<span class="sc">$</span><span class="fu">set</span>(<span class="at">root.dir =</span> project_dir)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="co"># Headless-safe plotting</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">dev =</span> <span class="st">&quot;ragg_png&quot;</span>, <span class="at">dpi =</span> <span class="dv">150</span>)</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="co"># Ensure figures dir exists</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(project_dir, <span class="st">&quot;figures&quot;</span>), <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="co"># Keep ragg from interpreting huge inch sizes</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a><span class="fu">options</span>(<span class="at">ragg.max_dim =</span> <span class="dv">10000</span>)  <span class="co"># optional; with units=&quot;px&quot; you shouldn&#39;t hit the cap</span></span></code></pre></div>
<p># Load packages</p>
<h1 id="need-to-add-to-container-geomsf">need to add to container:
geoMSF,</h1>
<h1 id="load-data">Load data</h1>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">#for interactive</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co"># Resolve paths relative to root.dir set above</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>ds <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="fu">file.path</span>(project_dir, ...)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>county_annual  <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="fu">ds</span>(<span class="st">&quot;handoffs/county_annual_long/county_annual.parquet&quot;</span>))</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>county_monthly <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="fu">ds</span>(<span class="st">&quot;handoffs/county_monthly_long/county_monthly.parquet&quot;</span>))</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>tract_annual   <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="fu">ds</span>(<span class="st">&quot;handoffs/tract_annual_long/tract_annual.parquet&quot;</span>))</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>tract_monthly  <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(<span class="fu">ds</span>(<span class="st">&quot;handoffs/tract_monthly_long/tract_monthly.parquet&quot;</span>))</span></code></pre></div>
<h1></h1>
<h1 id="id_-county-annual-sanity-checks"># County-Annual Sanity
checks</h1>
<h1 id="r---check-for-duplicated-geoid-year-variable-combinations--anyduplicatedcounty_annualcgeoid-year-variable-----basic-shape---should-be-3144-counties-17-years-2010-2024-normal-and-static-x-vars--county_annual-----summarise------n_rows------n------n_counties--n_distinctgeoid------n_years-----n_distinctyear------n_vars------n_distinctvariable---------collect-----list-distinct-years-in-the-dataset--county_annual-----distinctyear-----arrangeyear-----collect------var_summary---county_annual-----group_byvariable-----summarise------min_val----minvalue-narm--true------max_val----maxvalue-narm--true------mean_val---meanvalue-narm--true------median_val--medianvalue-narm--true------sd_val-----sdvalue-narm--true---------arrangevariable-----collect-------expected-ranges-table--expected_ranges---tribble----variable-----------------------min_exp--max_exp----aet---------------------------0--------250----albedo------------------------0--------09----area_km2----------------------5--------383000----bcsmass-----------------------1e-11----1e-8----be30_grd----------------------0--------6000----cldtot------------------------0--------1----def---------------------------0--------300----ds30_grd----------------------0--------6000----dusmass25---------------------1e-11----2e-8----evi----------------------------01-----1----etr---------------------------0--------18----evap--------------------------1e-8-----1e-4----fractional_impervious_surface-0--------100----grn---------------------------0--------1----gwetroot----------------------0--------1----koppen_1----------------------0--------1----koppen_14---------------------0--------1----koppen_15---------------------0--------1----koppen_16---------------------0--------1----koppen_17---------------------0--------1----koppen_18---------------------0--------1----koppen_19---------------------0--------1----koppen_2----------------------0--------1----koppen_21---------------------0--------1----koppen_22---------------------0--------1----koppen_23---------------------0--------1----koppen_25---------------------0--------1----koppen_26---------------------0--------1----koppen_27---------------------0--------1----koppen_29---------------------0--------1----koppen_3----------------------0--------1----koppen_30---------------------0--------1----koppen_4----------------------0--------1----koppen_5----------------------0--------1----koppen_6----------------------0--------1----koppen_7----------------------0--------1----koppen_8----------------------0--------1----koppen_9----------------------0--------1----koppen_confidence-------------0--------100----lai---------------------------0--------7---land_cover_11-----------------0--------1----land_cover_12-----------------0--------1----land_cover_21-----------------0--------1----land_cover_22-----------------0--------1----land_cover_23-----------------0--------1----land_cover_24-----------------0--------1----land_cover_31-----------------0--------1----land_cover_41-----------------0--------1----land_cover_42-----------------0--------1----land_cover_43-----------------0--------1----land_cover_52-----------------0--------1----land_cover_71-----------------0--------1----land_cover_81-----------------0--------1----land_cover_82-----------------0--------1----land_cover_90-----------------0--------1----land_cover_95-----------------0--------1----land_cover_confidence----0--------100----lst_day_1km_k-----------------230------330----lst_night_1km_k---------------230------310----lwgab-------------------------200------400----md30_grd-----------------------400-----8850----mi30_grd-----------------------400-----8850----mn30_grd-----------------------400-----8850----mx30_grd----------------------0--------8850----ndvi---------------------------01-----1----pblh--------------------------50-------2500----pdsi---------------------------9-------20----pet---------------------------0--------350----ppt---------------------------0--------900----pr----------------------------0--------45----precsno-----------------------0--------7e-5----prectotcorr-------------------1e-6-----5e-4----prop_cover_burnaddwaterbody---0--------1----prop_cover_catchment----------0--------1----prop_cover_catchmentsp--------0--------1----prop_cover_huc12--------------0--------1----prop_cover_landsea------------0--------1----prop_cover_nhdarea------------0--------1----prop_cover_nhdwaterbody-------0--------1----prop_heavy_coverage-----------0--------1----prop_light_coverage-----------0--------1----prop_med_coverage-------------0--------1----ps----------------------------50000----105000----qv2m--------------------------0--------004----rmax--------------------------0--------100----rmin--------------------------0--------100----road_density_km_per_km2-------0--------8----sd30_grd----------------------0--------600----slp---------------------------99000----102500----soil--------------------------0--------420----solclear----------------------2--------35----solslope----------------------0--------40----soltotal----------------------0--------32----soltrans----------------------0--------1----sph---------------------------0--------003----srad--------------------------0--------400----sur_refl_b01------------------0--------06----sur_refl_b02------------------0--------06----sur_refl_b03------------------0--------07----sur_refl_b04------------------0--------06----sur_refl_b05------------------0--------05----sur_refl_b06------------------0--------05----sur_refl_b07------------------0--------05----swe---------------------------0--------1200----t2mdew------------------------230------350----tdmean-------------------------40------27----th----------------------------0--------360----tmax---------------------------50------50----tmean--------------------------10------30----tmin---------------------------60------30----tmmn--------------------------240------350----tmmx--------------------------240------350----total_air_lb------------------0--------1e8----total_air_lb_per_km2----------0--------1e5----total_air_lb_plus20km---------0--------1e8----total_fugitive_air_lb---------0--------1e8----total_fugitive_air_lb_per_km2-0--------1e5----total_fugitive_air_lb_plus20km0--------1e8----total_road_km-----------------0--------6e4----total_stack_air_lb------------0--------1e8----total_stack_air_lb_per_km2----0--------1e5----total_stack_air_lb_plus20km---0--------1e8----totexttau---------------------002-----030----ts----------------------------250------305----u10m---------------------------20------20----vap---------------------------0--------5----vpd---------------------------0--------6----vpdmax------------------------2--------60----vpdmin------------------------0--------30----vs----------------------------0--------20----ws----------------------------0--------14----z0m---------------------------1e-4-----3---------compare-observed-vs-expected--comparison---var_summary-----left_joinexpected_ranges-by--variable-----mutate------min_ok--min_val--min_exp------max_ok--max_val--max_exp------passes--ifelsemin_ok--max_ok-y-n---------selectvariable-min_val-max_val-min_exp-max_exp-passes----printcomparison-n--inf-------"><code>{r} # # check for duplicated geoid-year-variable combinations # anyDuplicated(county_annual[c(&quot;geoid&quot;, &quot;year&quot;, &quot;variable&quot;)]) #  # # Basic shape # # should be 3144 counties, 17 years (2010-2024) normal and static, X vars # county_annual %&gt;% #   summarise( #     n_rows     = n(), #     n_counties = n_distinct(geoid), #     n_years    = n_distinct(year), #     n_vars     = n_distinct(variable) #   ) %&gt;% #   collect() #  # # List distinct years in the dataset # county_annual %&gt;% #   distinct(year) %&gt;% #   arrange(year) %&gt;% #   collect() #  #  # var_summary &lt;- county_annual %&gt;% #   group_by(variable) %&gt;% #   summarise( #     min_val   = min(value, na.rm = TRUE), #     max_val   = max(value, na.rm = TRUE), #     mean_val  = mean(value, na.rm = TRUE), #     median_val = median(value, na.rm = TRUE), #     sd_val    = sd(value, na.rm = TRUE) #   ) %&gt;% #   arrange(variable) %&gt;% #   collect() #  #  # # Expected ranges table # expected_ranges &lt;- tribble( #   ~variable,                       ~min_exp,  ~max_exp, #   &quot;aet&quot;,                           0,        250, #   &quot;albedo&quot;,                        0,        0.9, #   &quot;area_km2&quot;,                      5,        383000, #   &quot;bcsmass&quot;,                       1e-11,    1e-8, #   &quot;be30_grd&quot;,                      0,        6000, #   &quot;cldtot&quot;,                        0,        1, #   &quot;def&quot;,                           0,        300, #   &quot;ds30_grd&quot;,                      0,        6000, #   &quot;dusmass25&quot;,                     1e-11,    2e-8, #   &quot;evi&quot;,                           -0.1,     1, #   &quot;etr&quot;,                           0,        18, #   &quot;evap&quot;,                          1e-8,     1e-4, #   &quot;fractional_impervious_surface&quot;, 0,        100, #   &quot;grn&quot;,                           0,        1, #   &quot;gwetroot&quot;,                      0,        1, #   &quot;koppen_1&quot;,                      0,        1, #   &quot;koppen_14&quot;,                     0,        1, #   &quot;koppen_15&quot;,                     0,        1, #   &quot;koppen_16&quot;,                     0,        1, #   &quot;koppen_17&quot;,                     0,        1, #   &quot;koppen_18&quot;,                     0,        1, #   &quot;koppen_19&quot;,                     0,        1, #   &quot;koppen_2&quot;,                      0,        1, #   &quot;koppen_21&quot;,                     0,        1, #   &quot;koppen_22&quot;,                     0,        1, #   &quot;koppen_23&quot;,                     0,        1, #   &quot;koppen_25&quot;,                     0,        1, #   &quot;koppen_26&quot;,                     0,        1, #   &quot;koppen_27&quot;,                     0,        1, #   &quot;koppen_29&quot;,                     0,        1, #   &quot;koppen_3&quot;,                      0,        1, #   &quot;koppen_30&quot;,                     0,        1, #   &quot;koppen_4&quot;,                      0,        1, #   &quot;koppen_5&quot;,                      0,        1, #   &quot;koppen_6&quot;,                      0,        1, #   &quot;koppen_7&quot;,                      0,        1, #   &quot;koppen_8&quot;,                      0,        1, #   &quot;koppen_9&quot;,                      0,        1, #   &quot;koppen_confidence&quot;,             0,        100, #   &quot;lai&quot;,                           0,        7, #  &quot;land_cover_11&quot;,                 0,        1, #   &quot;land_cover_12&quot;,                 0,        1, #   &quot;land_cover_21&quot;,                 0,        1, #   &quot;land_cover_22&quot;,                 0,        1, #   &quot;land_cover_23&quot;,                 0,        1, #   &quot;land_cover_24&quot;,                 0,        1, #   &quot;land_cover_31&quot;,                 0,        1, #   &quot;land_cover_41&quot;,                 0,        1, #   &quot;land_cover_42&quot;,                 0,        1, #   &quot;land_cover_43&quot;,                 0,        1, #   &quot;land_cover_52&quot;,                 0,        1, #   &quot;land_cover_71&quot;,                 0,        1, #   &quot;land_cover_81&quot;,                 0,        1, #   &quot;land_cover_82&quot;,                 0,        1, #   &quot;land_cover_90&quot;,                 0,        1, #   &quot;land_cover_95&quot;,                 0,        1, #   &quot;land_cover_confidence&quot;,    0,        100, #   &quot;lst_day_1km_k&quot;,                 230,      330, #   &quot;lst_night_1km_k&quot;,               230,      310, #   &quot;lwgab&quot;,                         200,      400, #   &quot;md30_grd&quot;,                      -400,     8850, #   &quot;mi30_grd&quot;,                      -400,     8850, #   &quot;mn30_grd&quot;,                      -400,     8850, #   &quot;mx30_grd&quot;,                      0,        8850, #   &quot;ndvi&quot;,                          -0.1,     1, #   &quot;pblh&quot;,                          50,       2500, #   &quot;pdsi&quot;,                          -9,       20, #   &quot;pet&quot;,                           0,        350, #   &quot;ppt&quot;,                           0,        900, #   &quot;pr&quot;,                            0,        45, #   &quot;precsno&quot;,                       0,        7e-5, #   &quot;prectotcorr&quot;,                   1e-6,     5e-4, #   &quot;prop_cover_burnaddwaterbody&quot;,   0,        1, #   &quot;prop_cover_catchment&quot;,          0,        1, #   &quot;prop_cover_catchmentsp&quot;,        0,        1, #   &quot;prop_cover_huc12&quot;,              0,        1, #   &quot;prop_cover_landsea&quot;,            0,        1, #   &quot;prop_cover_nhdarea&quot;,            0,        1, #   &quot;prop_cover_nhdwaterbody&quot;,       0,        1, #   &quot;prop_heavy_coverage&quot;,           0,        1, #   &quot;prop_light_coverage&quot;,           0,        1, #   &quot;prop_med_coverage&quot;,             0,        1, #   &quot;ps&quot;,                            50000,    105000, #   &quot;qv2m&quot;,                          0,        0.04, #   &quot;rmax&quot;,                          0,        100, #   &quot;rmin&quot;,                          0,        100, #   &quot;road_density_km_per_km2&quot;,       0,        8, #   &quot;sd30_grd&quot;,                      0,        600, #   &quot;slp&quot;,                           99000,    102500, #   &quot;soil&quot;,                          0,        420, #   &quot;solclear&quot;,                      2,        35, #   &quot;solslope&quot;,                      0,        40, #   &quot;soltotal&quot;,                      0,        32, #   &quot;soltrans&quot;,                      0,        1, #   &quot;sph&quot;,                           0,        0.03, #   &quot;srad&quot;,                          0,        400, #   &quot;sur_refl_b01&quot;,                  0,        0.6, #   &quot;sur_refl_b02&quot;,                  0,        0.6, #   &quot;sur_refl_b03&quot;,                  0,        0.7, #   &quot;sur_refl_b04&quot;,                  0,        0.6, #   &quot;sur_refl_b05&quot;,                  0,        0.5, #   &quot;sur_refl_b06&quot;,                  0,        0.5, #   &quot;sur_refl_b07&quot;,                  0,        0.5, #   &quot;swe&quot;,                           0,        1200, #   &quot;t2mdew&quot;,                        230,      350, #   &quot;tdmean&quot;,                        -40,      27, #   &quot;th&quot;,                            0,        360, #   &quot;tmax&quot;,                          -50,      50, #   &quot;tmean&quot;,                         -10,      30, #   &quot;tmin&quot;,                          -60,      30, #   &quot;tmmn&quot;,                          240,      350, #   &quot;tmmx&quot;,                          240,      350, #   &quot;total_air_lb&quot;,                  0,        1e8, #   &quot;total_air_lb_per_km2&quot;,          0,        1e5, #   &quot;total_air_lb_plus20km&quot;,         0,        1e8, #   &quot;total_fugitive_air_lb&quot;,         0,        1e8, #   &quot;total_fugitive_air_lb_per_km2&quot;, 0,        1e5, #   &quot;total_fugitive_air_lb_plus20km&quot;,0,        1e8, #   &quot;total_road_km&quot;,                 0,        6e4, #   &quot;total_stack_air_lb&quot;,            0,        1e8, #   &quot;total_stack_air_lb_per_km2&quot;,    0,        1e5, #   &quot;total_stack_air_lb_plus20km&quot;,   0,        1e8, #   &quot;totexttau&quot;,                     0.02,     0.30, #   &quot;ts&quot;,                            250,      305, #   &quot;u10m&quot;,                          -20,      20, #   &quot;vap&quot;,                           0,        5, #   &quot;vpd&quot;,                           0,        6, #   &quot;vpdmax&quot;,                        2,        60, #   &quot;vpdmin&quot;,                        0,        30, #   &quot;vs&quot;,                            0,        20, #   &quot;ws&quot;,                            0,        14, #   &quot;z0m&quot;,                           1e-4,     3 #  # ) #  # # Compare observed vs expected # comparison &lt;- var_summary %&gt;% #   left_join(expected_ranges, by = &quot;variable&quot;) %&gt;% #   mutate( #     min_ok = min_val &gt;= min_exp, #     max_ok = max_val &lt;= max_exp, #     passes = ifelse(min_ok &amp; max_ok, &quot;Y&quot;, &quot;N&quot;) #   ) %&gt;% #   select(variable, min_val, max_val, min_exp, max_exp, passes) #  # print(comparison, n = Inf) #  #  #  #</code></h1>
<h1 id="id_-1"></h1>
<h1 id="id_-2"></h1>
<h1 id="id_-3"></h1>
<h1 id="id_-4"></h1>
<h1 id="plot-county-annual-rmax-over-time">Plot: County Annual rmax over
time</h1>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Geometries</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>counties <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;counties_500k&quot;</span>,</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;02&quot;</span>, <span class="st">&quot;15&quot;</span>))  <span class="co"># drop AK + HI</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>rmax_df <span class="ot">&lt;-</span> county_annual <span class="sc">%&gt;%</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">&quot;rmax&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, value) <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(rmax_df, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co"># Frame count without NAs</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>year <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;County-annual Rmax (GridMET max relative humidity): {closest_state}&quot;</span>,</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Rmax&quot;</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  <span class="fu">transition_states</span>(year, <span class="at">transition_length =</span> <span class="dv">1</span>, <span class="at">state_length =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="fu">ease_aes</span>(<span class="st">&quot;linear&quot;</span>)</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  p,                       <span class="co"># or `final` for the HMS plot</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">2</span>,</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,      </span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>)</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/rmax_county_annual.gif&quot;</span>), anim)</span></code></pre></div>
<p><img role="img" src="figures/rmax_county_annual.gif" /></p>
<h1 id="plot-county-annual-hms-smoke-proportions-over-time-with-ak--hi-insets">Plot:
County Annual HMS smoke proportions over time (with AK + HI insets)</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">library</span>(gganimate)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co"># --- Load county geometries (includes Alaska + Hawaii) ---</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>counties_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;counties_500k&quot;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co"># --- Extract HMS smoke proportion variables ---</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>smoke_df <span class="ot">&lt;-</span> county_annual <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>    <span class="st">&quot;prop_light_coverage&quot;</span>,</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>    <span class="st">&quot;prop_med_coverage&quot;</span>,</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    <span class="st">&quot;prop_heavy_coverage&quot;</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, variable, value) <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="co"># --- Pivot to wide format for priority calculation ---</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>smoke_wide <span class="ot">&lt;-</span> smoke_df <span class="sc">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    <span class="at">names_from  =</span> variable,</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>    <span class="at">values_from =</span> value,</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>    <span class="at">category =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>      prop_heavy_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Heavy&quot;</span>,</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>      prop_med_coverage   <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Medium&quot;</span>,</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>      prop_light_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Light&quot;</span>,</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>      <span class="cn">TRUE</span>                    <span class="sc">~</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>    ),</span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>    <span class="at">final_value =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Heavy&quot;</span>  <span class="sc">~</span> prop_heavy_coverage,</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Medium&quot;</span> <span class="sc">~</span> prop_med_coverage,</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Light&quot;</span>  <span class="sc">~</span> prop_light_coverage,</span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>      <span class="cn">TRUE</span>                 <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>    )</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>  )</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties_all <span class="sc">%&gt;%</span></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>  <span class="fu">left_join</span>(smoke_wide, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.)))</span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a><span class="co"># --- Remove Hawaii ONLY ---</span></span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)   <span class="co"># Keep Alaska, drop Hawaii</span></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a><span class="co"># --- Custom smoke colors ---</span></span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>smoke_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>  <span class="st">&quot;Light&quot;</span>  <span class="ot">=</span> <span class="st">&quot;#eccc7c&quot;</span>,</span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>  <span class="st">&quot;Medium&quot;</span> <span class="ot">=</span> <span class="st">&quot;#dc8b30&quot;</span>,</span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>  <span class="st">&quot;Heavy&quot;</span>  <span class="ot">=</span> <span class="st">&quot;#d96527&quot;</span>,</span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>  <span class="st">&quot;None&quot;</span>   <span class="ot">=</span> <span class="st">&quot;#dfdac4&quot;</span></span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>)</span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a><span class="co"># --- Set category factor levels in desired order ---</span></span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">category =</span> <span class="fu">factor</span>(category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)))</span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a><span class="co"># --- Build animated plot ---</span></span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> category, <span class="at">alpha =</span> final_value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>    <span class="at">values =</span> smoke_colors,</span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>),  <span class="co"># &lt;- Ensures correct legend order</span></span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span></span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>  <span class="fu">scale_alpha</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb4-81"><a href="#cb4-81" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb4-82"><a href="#cb4-82" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-83"><a href="#cb4-83" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb4-84"><a href="#cb4-84" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb4-85"><a href="#cb4-85" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb4-86"><a href="#cb4-86" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb4-87"><a href="#cb4-87" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb4-88"><a href="#cb4-88" tabindex="-1"></a>    <span class="at">plot.title   =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb4-89"><a href="#cb4-89" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-90"><a href="#cb4-90" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-91"><a href="#cb4-91" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;County-Annual HMS Smoke Coverage  Year: {current_frame}&quot;</span>,</span>
<span id="cb4-92"><a href="#cb4-92" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Smoke Category&quot;</span></span>
<span id="cb4-93"><a href="#cb4-93" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-94"><a href="#cb4-94" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(year)</span>
<span id="cb4-95"><a href="#cb4-95" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" tabindex="-1"></a></span>
<span id="cb4-97"><a href="#cb4-97" tabindex="-1"></a><span class="co"># --- Count frames safely ---</span></span>
<span id="cb4-98"><a href="#cb4-98" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>year <span class="sc">%&gt;%</span></span>
<span id="cb4-99"><a href="#cb4-99" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-100"><a href="#cb4-100" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-101"><a href="#cb4-101" tabindex="-1"></a>  <span class="fu">length</span>()</span>
<span id="cb4-102"><a href="#cb4-102" tabindex="-1"></a></span>
<span id="cb4-103"><a href="#cb4-103" tabindex="-1"></a><span class="co"># --- Animate using ragg ---</span></span>
<span id="cb4-104"><a href="#cb4-104" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb4-105"><a href="#cb4-105" tabindex="-1"></a>  p_main,</span>
<span id="cb4-106"><a href="#cb4-106" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb4-107"><a href="#cb4-107" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">2</span>,</span>
<span id="cb4-108"><a href="#cb4-108" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb4-109"><a href="#cb4-109" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb4-110"><a href="#cb4-110" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb4-111"><a href="#cb4-111" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb4-112"><a href="#cb4-112" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb4-113"><a href="#cb4-113" tabindex="-1"></a>)</span>
<span id="cb4-114"><a href="#cb4-114" tabindex="-1"></a></span>
<span id="cb4-115"><a href="#cb4-115" tabindex="-1"></a><span class="co"># --- Save animation ---</span></span>
<span id="cb4-116"><a href="#cb4-116" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/hms_smoke_county_annual.gif&quot;</span>), anim)</span>
<span id="cb4-117"><a href="#cb4-117" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" tabindex="-1"></a><span class="co"># --- Display inline ---</span></span>
<span id="cb4-119"><a href="#cb4-119" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/hms_smoke_county_annual.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/hms_smoke_county_annual.gif" /><!-- --> <img role="img" src="figures/hms_smoke_county_annual.gif" /></p>
<h1 id="id_-5"></h1>
<h1 id="id_-6"></h1>
<h1 id="id_-7"></h1>
<h1 id="id_-county-monthly-sanity-checks"># County-Monthly Sanity
checks</h1>
<h1 id="r---check-for-duplicated-geoid-year-variable-combinations--anyduplicatedcounty_monthlycgeoid-year-variable-----basic-shape---should-be-3144-counties-17-years-2010-2024-normal-and-static-139-vars--county_monthly-----summarise------n_rows------n------n_counties--n_distinctgeoid------n_years-----n_distinctyear------n_vars------n_distinctvariable---------collect-----list-distinct-years-and-months-in-the-dataset--county_monthly-----distinctyear-month-----arrangeyear-month-----collect-----printn--inf------county_monthly-----filterisnayear--isnamonth-----distinctvariable-----arrangevariable-----collect-----printn--inf------var_summary---county_monthly-----group_byvariable-----summarise------min_val----minvalue-narm--true------max_val----maxvalue-narm--true------mean_val---meanvalue-narm--true------median_val--medianvalue-narm--true------sd_val-----sdvalue-narm--true---------arrangevariable-----collect-------compare-observed-vs-expected--comparison---var_summary-----left_joinexpected_ranges-by--variable-----mutate------min_ok--min_val--min_exp------max_ok--max_val--max_exp------passes--ifelsemin_ok--max_ok-y-n---------selectvariable-min_val-max_val-min_exp-max_exp-passes----printcomparison-n--inf---"><code>{r} # # check for duplicated geoid-year-variable combinations # anyDuplicated(county_monthly[c(&quot;geoid&quot;, &quot;year&quot;, &quot;variable&quot;)]) #  # # Basic shape # # should be 3144 counties, 17 years (2010-2024) normal and static, 139 vars # county_monthly %&gt;% #   summarise( #     n_rows     = n(), #     n_counties = n_distinct(geoid), #     n_years    = n_distinct(year), #     n_vars     = n_distinct(variable) #   ) %&gt;% #   collect() #  # # List distinct years and months in the dataset # county_monthly %&gt;% #   distinct(year, month) %&gt;% #   arrange(year, month) %&gt;% #   collect() %&gt;% #   print(n = Inf) #  #  # county_monthly %&gt;% #   filter(is.na(year) &amp; is.na(month)) %&gt;% #   distinct(variable) %&gt;% #   arrange(variable) %&gt;% #   collect() %&gt;% #   print(n = Inf) #  #  # var_summary &lt;- county_monthly %&gt;% #   group_by(variable) %&gt;% #   summarise( #     min_val   = min(value, na.rm = TRUE), #     max_val   = max(value, na.rm = TRUE), #     mean_val  = mean(value, na.rm = TRUE), #     median_val = median(value, na.rm = TRUE), #     sd_val    = sd(value, na.rm = TRUE) #   ) %&gt;% #   arrange(variable) %&gt;% #   collect() #  #  # # Compare observed vs expected # comparison &lt;- var_summary %&gt;% #   left_join(expected_ranges, by = &quot;variable&quot;) %&gt;% #   mutate( #     min_ok = min_val &gt;= min_exp, #     max_ok = max_val &lt;= max_exp, #     passes = ifelse(min_ok &amp; max_ok, &quot;Y&quot;, &quot;N&quot;) #   ) %&gt;% #   select(variable, min_val, max_val, min_exp, max_exp, passes) #  # print(comparison, n = Inf) #  #</code></h1>
<h1 id="id_-8"></h1>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Plot: County-Monthly Rmax Over Time</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co"># --- Load county geometries ---</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>counties_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;counties_500k&quot;</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co"># --- Extract Rmax values ---</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>rmax_df <span class="ot">&lt;-</span> county_monthly <span class="sc">%&gt;%</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">&quot;rmax&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, month, value) <span class="sc">%&gt;%</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">frame_id =</span> <span class="fu">paste</span>(year, <span class="fu">sprintf</span>(<span class="st">&quot;%02d&quot;</span>, month), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties_all <span class="sc">%&gt;%</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="fu">left_join</span>(rmax_df, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)  <span class="co"># Remove Hawaii</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co"># --- Build plot ---</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;County-Monthly Rmax (GridMET Max Relative Humidity): {current_frame}&quot;</span>,</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Rmax&quot;</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(frame_id)</span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>frame_id <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  p,</span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">6</span>,</span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a>)</span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/rmax_county_monthly.gif&quot;</span>), anim)</span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/rmax_county_monthly.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/rmax_county_monthly.gif" /><!-- --></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># Plot: County Monthly HMS Smoke Coverage Over Time</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># --- Load county geometries (includes Alaska + Hawaii) ---</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>counties_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;counties_500k&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co"># --- Extract HMS smoke proportion variables ---</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>smoke_df <span class="ot">&lt;-</span> county_monthly <span class="sc">%&gt;%</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="st">&quot;prop_light_coverage&quot;</span>,</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    <span class="st">&quot;prop_med_coverage&quot;</span>,</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    <span class="st">&quot;prop_heavy_coverage&quot;</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, month, variable, value) <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co"># --- Pivot to wide format for priority calculation ---</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>smoke_wide <span class="ot">&lt;-</span> smoke_df <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>    <span class="at">names_from  =</span> variable,</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>    <span class="at">values_from =</span> value,</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>    <span class="at">category =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>      prop_heavy_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Heavy&quot;</span>,</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>      prop_med_coverage   <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Medium&quot;</span>,</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>      prop_light_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Light&quot;</span>,</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>      <span class="cn">TRUE</span>                    <span class="sc">~</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>    ),</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>    <span class="at">final_value =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Heavy&quot;</span>  <span class="sc">~</span> prop_heavy_coverage,</span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Medium&quot;</span> <span class="sc">~</span> prop_med_coverage,</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Light&quot;</span>  <span class="sc">~</span> prop_light_coverage,</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>      <span class="cn">TRUE</span>                 <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>    ),</span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>    <span class="at">frame_id =</span> <span class="fu">paste</span>(year, <span class="fu">sprintf</span>(<span class="st">&quot;%02d&quot;</span>, month), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>) <span class="co"># YYYY-MM format</span></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>  )</span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties_all <span class="sc">%&gt;%</span></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>  <span class="fu">left_join</span>(smoke_wide, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.)))</span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a><span class="co"># --- Remove Hawaii ONLY ---</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)</span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="co"># --- Custom smoke colors ---</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a>smoke_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a>  <span class="st">&quot;Light&quot;</span>  <span class="ot">=</span> <span class="st">&quot;#eccc7c&quot;</span>,</span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a>  <span class="st">&quot;Medium&quot;</span> <span class="ot">=</span> <span class="st">&quot;#dc8b30&quot;</span>,</span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a>  <span class="st">&quot;Heavy&quot;</span>  <span class="ot">=</span> <span class="st">&quot;#d96527&quot;</span>,</span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a>  <span class="st">&quot;None&quot;</span>   <span class="ot">=</span> <span class="st">&quot;#dfdac4&quot;</span></span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a>)</span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a><span class="co"># --- Set category order ---</span></span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">category =</span> <span class="fu">factor</span>(category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)))</span>
<span id="cb6-65"><a href="#cb6-65" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" tabindex="-1"></a><span class="co"># --- Build animated plot ---</span></span>
<span id="cb6-67"><a href="#cb6-67" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb6-68"><a href="#cb6-68" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> category, <span class="at">alpha =</span> final_value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb6-69"><a href="#cb6-69" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb6-70"><a href="#cb6-70" tabindex="-1"></a>    <span class="at">values =</span> smoke_colors,</span>
<span id="cb6-71"><a href="#cb6-71" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>),</span>
<span id="cb6-72"><a href="#cb6-72" tabindex="-1"></a>    <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span></span>
<span id="cb6-73"><a href="#cb6-73" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-74"><a href="#cb6-74" tabindex="-1"></a>  <span class="fu">scale_alpha</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb6-75"><a href="#cb6-75" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb6-76"><a href="#cb6-76" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb6-77"><a href="#cb6-77" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb6-78"><a href="#cb6-78" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb6-79"><a href="#cb6-79" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-80"><a href="#cb6-80" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb6-81"><a href="#cb6-81" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb6-82"><a href="#cb6-82" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb6-83"><a href="#cb6-83" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb6-84"><a href="#cb6-84" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb6-85"><a href="#cb6-85" tabindex="-1"></a>    <span class="at">plot.title   =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb6-86"><a href="#cb6-86" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-87"><a href="#cb6-87" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-88"><a href="#cb6-88" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;County-Monthly HMS Smoke Coverage  {current_frame}&quot;</span>,</span>
<span id="cb6-89"><a href="#cb6-89" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Smoke Category&quot;</span></span>
<span id="cb6-90"><a href="#cb6-90" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-91"><a href="#cb6-91" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(frame_id)</span>
<span id="cb6-92"><a href="#cb6-92" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb6-94"><a href="#cb6-94" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>frame_id <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb6-95"><a href="#cb6-95" tabindex="-1"></a></span>
<span id="cb6-96"><a href="#cb6-96" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb6-97"><a href="#cb6-97" tabindex="-1"></a>  p_main,</span>
<span id="cb6-98"><a href="#cb6-98" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb6-99"><a href="#cb6-99" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">6</span>,  <span class="co"># Faster since more frames</span></span>
<span id="cb6-100"><a href="#cb6-100" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb6-101"><a href="#cb6-101" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb6-102"><a href="#cb6-102" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb6-103"><a href="#cb6-103" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb6-104"><a href="#cb6-104" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb6-105"><a href="#cb6-105" tabindex="-1"></a>)</span>
<span id="cb6-106"><a href="#cb6-106" tabindex="-1"></a></span>
<span id="cb6-107"><a href="#cb6-107" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/hms_smoke_county_monthly.gif&quot;</span>), anim)</span>
<span id="cb6-108"><a href="#cb6-108" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/hms_smoke_county_monthly.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/hms_smoke_county_monthly.gif" /><!-- --></p>
<h1 id="id_-9"></h1>
<h1 id="id_-10"></h1>
<h1 id="id_-11"></h1>
<h1 id="id_-tract-annual-sanity-checks"># Tract-Annual Sanity
checks</h1>
<h1 id="r---check-for-duplicated-geoid-year-variable-combinations--anyduplicatedtract_annualcgeoid-year-variable-----basic-shape---should-be-over-84414-counties-17-years-2010-2024-normal-and-static-132-vars---84119-census-tracts---some-may-have-had-errors--tract_annual-----summarise------n_rows------n------n_tracts--n_distinctgeoid------n_years-----n_distinctyear------n_vars------n_distinctvariable---------collect-----list-distinct-years-in-the-dataset--tract_annual-----distinctyear-----arrangeyear-----collect------var_summary---tract_annual-----group_byvariable-----summarise------min_val----minvalue-narm--true------max_val----maxvalue-narm--true------mean_val---meanvalue-narm--true------median_val--medianvalue-narm--true------sd_val-----sdvalue-narm--true---------arrangevariable-----collect-------compare-observed-vs-expected--comparison---var_summary-----left_joinexpected_ranges-by--variable-----mutate------min_ok--min_val--min_exp------max_ok--max_val--max_exp------passes--ifelsemin_ok--max_ok-y-n---------selectvariable-min_val-max_val-min_exp-max_exp-passes----printcomparison-n--inf---"><code>{r} # # check for duplicated geoid-year-variable combinations # anyDuplicated(tract_annual[c(&quot;geoid&quot;, &quot;year&quot;, &quot;variable&quot;)]) #  # # Basic shape # # should be over 84,414 counties, 17 years (2010-2024) normal and static, 132 vars # # 84119 census tracts - some may have had errors # tract_annual %&gt;% #   summarise( #     n_rows     = n(), #     n_tracts = n_distinct(geoid), #     n_years    = n_distinct(year), #     n_vars     = n_distinct(variable) #   ) %&gt;% #   collect() #  # # List distinct years in the dataset # tract_annual %&gt;% #   distinct(year) %&gt;% #   arrange(year) %&gt;% #   collect() #  #  # var_summary &lt;- tract_annual %&gt;% #   group_by(variable) %&gt;% #   summarise( #     min_val   = min(value, na.rm = TRUE), #     max_val   = max(value, na.rm = TRUE), #     mean_val  = mean(value, na.rm = TRUE), #     median_val = median(value, na.rm = TRUE), #     sd_val    = sd(value, na.rm = TRUE) #   ) %&gt;% #   arrange(variable) %&gt;% #   collect() #  #  # # Compare observed vs expected # comparison &lt;- var_summary %&gt;% #   left_join(expected_ranges, by = &quot;variable&quot;) %&gt;% #   mutate( #     min_ok = min_val &gt;= min_exp, #     max_ok = max_val &lt;= max_exp, #     passes = ifelse(min_ok &amp; max_ok, &quot;Y&quot;, &quot;N&quot;) #   ) %&gt;% #   select(variable, min_val, max_val, min_exp, max_exp, passes) #  # print(comparison, n = Inf) #  #</code></h1>
<h1 id="id_-12"></h1>
<h1 id="id_-13"></h1>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># Plot: Tract-Annual Rmax Over Time</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co"># --- Load tract geometries ---</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>tracts_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;tracts_500k&quot;</span>,</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co"># --- Extract Rmax values ---</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>rmax_df <span class="ot">&lt;-</span> tract_annual <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">&quot;rmax&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, value) <span class="sc">%&gt;%</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties_all <span class="sc">%&gt;%</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>  <span class="fu">left_join</span>(rmax_df, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)  <span class="co"># Remove Hawaii</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a><span class="co"># --- Build plot ---</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Tract-Annual Rmax (GridMET Max Relative Humidity): {current_frame}&quot;</span>,</span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Rmax&quot;</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(year)</span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>year <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>  p,</span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">2</span>,</span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in lapply(row_vars$frames, as.integer): NAs introduced by coercion

## Warning in split.data.frame(d, as.integer(split_panel[, 3])): NAs introduced by
## coercion

## Warning: Cannot get dimensions of plot table. Plot region might not be fixed
## Caused by error in `geom_sf()`:
## ! Problem while converting geom to grob.
##  Error occurred in the 1st layer.
## Caused by error in `if (empty(data)) ...`:
## ! missing value where TRUE/FALSE needed

## Warning: Failed to plot frame
## Caused by error in `geom_sf()`:
## ! Problem while converting geom to grob.
##  Error occurred in the 1st layer.
## Caused by error in `if (empty(data)) ...`:
## ! missing value where TRUE/FALSE needed</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/rmax_tract_annual.gif&quot;</span>), anim)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/rmax_tract_annual.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/rmax_tract_annual.gif" /><!-- --></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># Plot: Tract Annual HMS Smoke Coverage Over Time</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co"># --- Load tract geometries (includes Alaska + Hawaii) ---</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>tracts_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;tracts_500k&quot;</span>,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a><span class="co"># --- Extract HMS smoke proportion variables ---</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>smoke_df <span class="ot">&lt;-</span> tract_annual <span class="sc">%&gt;%</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>    <span class="st">&quot;prop_light_coverage&quot;</span>,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>    <span class="st">&quot;prop_med_coverage&quot;</span>,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>    <span class="st">&quot;prop_heavy_coverage&quot;</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, variable, value) <span class="sc">%&gt;%</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co"># --- Pivot and calculate priority ---</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>smoke_wide <span class="ot">&lt;-</span> smoke_df <span class="sc">%&gt;%</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>    <span class="at">names_from  =</span> variable,</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>    <span class="at">values_from =</span> value,</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>      prop_heavy_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Heavy&quot;</span>,</span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>      prop_med_coverage   <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Medium&quot;</span>,</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>      prop_light_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Light&quot;</span>,</span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>      <span class="cn">TRUE</span>                    <span class="sc">~</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>    ),</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>    <span class="at">final_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Heavy&quot;</span>  <span class="sc">~</span> prop_heavy_coverage,</span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Medium&quot;</span> <span class="sc">~</span> prop_med_coverage,</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Light&quot;</span>  <span class="sc">~</span> prop_light_coverage,</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>      <span class="cn">TRUE</span>                 <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>    )</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>  )</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> tracts_all <span class="sc">%&gt;%</span></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a>  <span class="fu">left_join</span>(smoke_wide, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.)))</span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a><span class="co"># --- Remove Hawaii ---</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)</span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a><span class="co"># --- Set colors and order ---</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">category =</span> <span class="fu">factor</span>(category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)))</span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> category, <span class="at">alpha =</span> final_value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> smoke_colors, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)) <span class="sc">+</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>  <span class="fu">scale_alpha</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a>    <span class="at">plot.title   =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Tract-Annual HMS Smoke Coverage  Year: {current_frame}&quot;</span>,</span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Smoke Category&quot;</span></span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(year)</span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>year <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a></span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a>  p_main,</span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">2</span>,</span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb10-87"><a href="#cb10-87" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb10-88"><a href="#cb10-88" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb10-89"><a href="#cb10-89" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb10-90"><a href="#cb10-90" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb10-91"><a href="#cb10-91" tabindex="-1"></a>)</span>
<span id="cb10-92"><a href="#cb10-92" tabindex="-1"></a></span>
<span id="cb10-93"><a href="#cb10-93" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/hms_smoke_tract_annual.gif&quot;</span>), anim)</span>
<span id="cb10-94"><a href="#cb10-94" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/hms_smoke_tract_annual.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/hms_smoke_tract_annual.gif" /><!-- --></p>
<h1 id="id_-14"></h1>
<h1 id="id_-tract-monthly-sanity-checks"># Tract-Monthly Sanity
checks</h1>
<h1 id="r---check-for-duplicated-geoid-year-variable-combinations--anyduplicatedtract_monthlycgeoid-year-variable-----basic-shape---should-be-over-84414-counties-17-years-2010-2024-normal-and-static-140-vars---84119-census-tracts---some-may-have-had-errors----tract_monthly-----summarise------n_rows------n------n_tracts--n_distinctgeoid------n_years-----n_distinctyear------n_vars------n_distinctvariable---------collect-------list-distinct-years-in-the-dataset--tract_monthly-----distinctyear-month-----arrangeyear-month-----collect-----printn--inf-----terraclimate-variables-with-missing-yearmonth-go-back-and-fix----tract_monthly-----filterisnayear--isnamonth-----distinctvariable-----arrangevariable-----collect-----printn--inf-----terraclimate-variables-with-missing-yearmonth-go-back-and-fix----var_summary---tract_monthly-----group_byvariable-----summarise------min_val----minvalue-narm--true------max_val----maxvalue-narm--true------mean_val---meanvalue-narm--true------median_val--medianvalue-narm--true------sd_val-----sdvalue-narm--true---------arrangevariable-----collect-----compare-observed-vs-expected--comparison---var_summary-----left_joinexpected_ranges-by--variable-----mutate------min_ok--min_val--min_exp------max_ok--max_val--max_exp------passes--ifelsemin_ok--max_ok-y-n---------selectvariable-min_val-max_val-min_exp-max_exp-passes----printcomparison-n--inf-"><code>{r} # # check for duplicated geoid-year-variable combinations # anyDuplicated(tract_monthly[c(&quot;geoid&quot;, &quot;year&quot;, &quot;variable&quot;)]) #  # # Basic shape # # should be over 84,414 counties, 17 years (2010-2024) normal and static, 140 vars # # 84119 census tracts - some may have had errors #  # tract_monthly %&gt;% #   summarise( #     n_rows     = n(), #     n_tracts = n_distinct(geoid), #     n_years    = n_distinct(year), #     n_vars     = n_distinct(variable) #   ) %&gt;% #   collect() #  #  # # List distinct years in the dataset # tract_monthly %&gt;% #   distinct(year, month) %&gt;% #   arrange(year, month) %&gt;% #   collect() %&gt;% #   print(n = Inf) #  # # terraclimate variables with missing year/month. go back and fix #  # tract_monthly %&gt;% #   filter(is.na(year) &amp; is.na(month)) %&gt;% #   distinct(variable) %&gt;% #   arrange(variable) %&gt;% #   collect() %&gt;% #   print(n = Inf) #  # # terraclimate variables with missing year/month. go back and fix #  # var_summary &lt;- tract_monthly %&gt;% #   group_by(variable) %&gt;% #   summarise( #     min_val   = min(value, na.rm = TRUE), #     max_val   = max(value, na.rm = TRUE), #     mean_val  = mean(value, na.rm = TRUE), #     median_val = median(value, na.rm = TRUE), #     sd_val    = sd(value, na.rm = TRUE) #   ) %&gt;% #   arrange(variable) %&gt;% #   collect() #  # # Compare observed vs expected # comparison &lt;- var_summary %&gt;% #   left_join(expected_ranges, by = &quot;variable&quot;) %&gt;% #   mutate( #     min_ok = min_val &gt;= min_exp, #     max_ok = max_val &lt;= max_exp, #     passes = ifelse(min_ok &amp; max_ok, &quot;Y&quot;, &quot;N&quot;) #   ) %&gt;% #   select(variable, min_val, max_val, min_exp, max_exp, passes) #  # print(comparison, n = Inf) #</code></h1>
<h1 id="id_-15"></h1>
<h1 id="id_-16"></h1>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># Plot: Tract-Monthly Rmax Over Time</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co"># --- Load tract geometries ---</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>tracts_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;tracts_500k&quot;</span>,</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co"># --- Extract Rmax values ---</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>rmax_df <span class="ot">&lt;-</span> tract_monthly <span class="sc">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">==</span> <span class="st">&quot;rmax&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, month, value) <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">frame_id =</span> <span class="fu">paste</span>(year, <span class="fu">sprintf</span>(<span class="st">&quot;%02d&quot;</span>, month), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>))</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> counties_all <span class="sc">%&gt;%</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>  <span class="fu">left_join</span>(rmax_df, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.))) <span class="sc">%&gt;%</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)  <span class="co"># Remove Hawaii</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="co"># --- Build plot ---</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>, <span class="at">na.value =</span> <span class="st">&quot;grey80&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Tract-Monthly Rmax (GridMET Max Relative Humidity): {current_frame}&quot;</span>,</span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Rmax&quot;</span></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(frame_id)</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>frame_id <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a>  p,</span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">6</span>,</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in lapply(row_vars$frames, as.integer): NAs introduced by coercion

## Warning in split.data.frame(d, as.integer(split_panel[, 3])): NAs introduced by
## coercion

## Warning: Cannot get dimensions of plot table. Plot region might not be fixed
## Caused by error in `geom_sf()`:
## ! Problem while converting geom to grob.
##  Error occurred in the 1st layer.
## Caused by error in `if (empty(data)) ...`:
## ! missing value where TRUE/FALSE needed

## Warning: Failed to plot frame
## Caused by error in `geom_sf()`:
## ! Problem while converting geom to grob.
##  Error occurred in the 1st layer.
## Caused by error in `if (empty(data)) ...`:
## ! missing value where TRUE/FALSE needed</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/rmax_tract_monthly.gif&quot;</span>), anim)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/rmax_tract_monthly.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/rmax_tract_monthly.gif" /><!-- --></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># Plot: Tract Monthly HMS Smoke Coverage Over Time</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co"># --- Load tract geometries ---</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>tracts_all <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_read</span>(</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="fu">ds</span>(<span class="st">&quot;clean_data/county_census/canonical_2024.gpkg&quot;</span>),</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="at">layer =</span> <span class="st">&quot;tracts_500k&quot;</span>,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_make_valid</span>()</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co"># --- Extract HMS smoke proportion variables ---</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>smoke_df <span class="ot">&lt;-</span> tract_monthly <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  <span class="fu">filter</span>(variable <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>    <span class="st">&quot;prop_light_coverage&quot;</span>,</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>    <span class="st">&quot;prop_med_coverage&quot;</span>,</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>    <span class="st">&quot;prop_heavy_coverage&quot;</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="fu">select</span>(geoid, year, month, variable, value) <span class="sc">%&gt;%</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a><span class="co"># --- Pivot and calculate priority ---</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>smoke_wide <span class="ot">&lt;-</span> smoke_df <span class="sc">%&gt;%</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>    <span class="at">names_from  =</span> variable,</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>    <span class="at">values_from =</span> value,</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>    <span class="at">category =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>      prop_heavy_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Heavy&quot;</span>,</span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>      prop_med_coverage   <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Medium&quot;</span>,</span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>      prop_light_coverage <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Light&quot;</span>,</span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>      <span class="cn">TRUE</span>                    <span class="sc">~</span> <span class="st">&quot;None&quot;</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>    ),</span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>    <span class="at">final_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Heavy&quot;</span>  <span class="sc">~</span> prop_heavy_coverage,</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Medium&quot;</span> <span class="sc">~</span> prop_med_coverage,</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>      category <span class="sc">==</span> <span class="st">&quot;Light&quot;</span>  <span class="sc">~</span> prop_light_coverage,</span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>      <span class="cn">TRUE</span>                 <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a>    ),</span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a>    <span class="at">frame_id =</span> <span class="fu">paste</span>(year, <span class="fu">sprintf</span>(<span class="st">&quot;%02d&quot;</span>, month), <span class="at">sep =</span> <span class="st">&quot;-&quot;</span>)</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a>  )</span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a><span class="co"># --- Join geometries ---</span></span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> tracts_all <span class="sc">%&gt;%</span></span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a>  <span class="fu">left_join</span>(smoke_wide, <span class="at">by =</span> <span class="st">&quot;geoid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>sf<span class="sc">::</span><span class="fu">st_is_empty</span>(sf<span class="sc">::</span><span class="fu">st_geometry</span>(.)))</span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a></span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a><span class="co"># --- Remove Hawaii ---</span></span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">substr</span>(geoid, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">!=</span> <span class="st">&quot;15&quot;</span>)</span>
<span id="cb14-54"><a href="#cb14-54" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" tabindex="-1"></a><span class="co"># --- Set colors and order ---</span></span>
<span id="cb14-56"><a href="#cb14-56" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">%&gt;%</span></span>
<span id="cb14-57"><a href="#cb14-57" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">category =</span> <span class="fu">factor</span>(category, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)))</span>
<span id="cb14-58"><a href="#cb14-58" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" tabindex="-1"></a>p_main <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_df) <span class="sc">+</span></span>
<span id="cb14-60"><a href="#cb14-60" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> category, <span class="at">alpha =</span> final_value), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb14-61"><a href="#cb14-61" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> smoke_colors, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="st">&quot;None&quot;</span>, <span class="st">&quot;Light&quot;</span>, <span class="st">&quot;Medium&quot;</span>, <span class="st">&quot;Heavy&quot;</span>)) <span class="sc">+</span></span>
<span id="cb14-62"><a href="#cb14-62" tabindex="-1"></a>  <span class="fu">scale_alpha</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb14-63"><a href="#cb14-63" tabindex="-1"></a>  <span class="fu">coord_sf</span>(</span>
<span id="cb14-64"><a href="#cb14-64" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">165</span>, <span class="sc">-</span><span class="dv">67</span>),</span>
<span id="cb14-65"><a href="#cb14-65" tabindex="-1"></a>    <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">72</span>),</span>
<span id="cb14-66"><a href="#cb14-66" tabindex="-1"></a>    <span class="at">expand =</span> <span class="cn">FALSE</span></span>
<span id="cb14-67"><a href="#cb14-67" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-68"><a href="#cb14-68" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb14-69"><a href="#cb14-69" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb14-70"><a href="#cb14-70" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb14-71"><a href="#cb14-71" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb14-72"><a href="#cb14-72" tabindex="-1"></a>    <span class="at">legend.text  =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>),</span>
<span id="cb14-73"><a href="#cb14-73" tabindex="-1"></a>    <span class="at">plot.title   =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">&quot;bold&quot;</span>)</span>
<span id="cb14-74"><a href="#cb14-74" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-75"><a href="#cb14-75" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-76"><a href="#cb14-76" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&quot;Tract-Monthly HMS Smoke Coverage  {current_frame}&quot;</span>,</span>
<span id="cb14-77"><a href="#cb14-77" tabindex="-1"></a>    <span class="at">fill  =</span> <span class="st">&quot;Smoke Category&quot;</span></span>
<span id="cb14-78"><a href="#cb14-78" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-79"><a href="#cb14-79" tabindex="-1"></a>  gganimate<span class="sc">::</span><span class="fu">transition_manual</span>(frame_id)</span>
<span id="cb14-80"><a href="#cb14-80" tabindex="-1"></a></span>
<span id="cb14-81"><a href="#cb14-81" tabindex="-1"></a><span class="co"># --- Animate ---</span></span>
<span id="cb14-82"><a href="#cb14-82" tabindex="-1"></a>nframes <span class="ot">&lt;-</span> plot_df<span class="sc">$</span>frame_id <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">na.last =</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span> <span class="fu">length</span>()</span>
<span id="cb14-83"><a href="#cb14-83" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" tabindex="-1"></a>anim <span class="ot">&lt;-</span> gganimate<span class="sc">::</span><span class="fu">animate</span>(</span>
<span id="cb14-85"><a href="#cb14-85" tabindex="-1"></a>  p_main,</span>
<span id="cb14-86"><a href="#cb14-86" tabindex="-1"></a>  <span class="at">nframes  =</span> <span class="fu">max</span>(<span class="dv">1</span><span class="dt">L</span>, nframes),</span>
<span id="cb14-87"><a href="#cb14-87" tabindex="-1"></a>  <span class="at">fps      =</span> <span class="dv">6</span>,</span>
<span id="cb14-88"><a href="#cb14-88" tabindex="-1"></a>  <span class="at">width    =</span> <span class="dv">1000</span>,</span>
<span id="cb14-89"><a href="#cb14-89" tabindex="-1"></a>  <span class="at">height   =</span> <span class="dv">600</span>,</span>
<span id="cb14-90"><a href="#cb14-90" tabindex="-1"></a>  <span class="at">units    =</span> <span class="st">&quot;px&quot;</span>,</span>
<span id="cb14-91"><a href="#cb14-91" tabindex="-1"></a>  <span class="at">renderer =</span> <span class="fu">gifski_renderer</span>(),</span>
<span id="cb14-92"><a href="#cb14-92" tabindex="-1"></a>  <span class="at">device   =</span> <span class="st">&quot;ragg_png&quot;</span></span>
<span id="cb14-93"><a href="#cb14-93" tabindex="-1"></a>)</span>
<span id="cb14-94"><a href="#cb14-94" tabindex="-1"></a></span>
<span id="cb14-95"><a href="#cb14-95" tabindex="-1"></a>gganimate<span class="sc">::</span><span class="fu">anim_save</span>(<span class="fu">ds</span>(<span class="st">&quot;figures/hms_smoke_tract_monthly.gif&quot;</span>), anim)</span>
<span id="cb14-96"><a href="#cb14-96" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;figures/hms_smoke_tract_monthly.gif&quot;</span>)</span></code></pre></div>
<p><img role="img" src="figures/hms_smoke_tract_monthly.gif" /><!-- --></p>
<h1 id="id_-17"></h1>
<h1 id="id_-to-do"># to do</h1>
<h1 id="id_--make-some-visualizations-of-select-variables-over-time-and-space-using-ggplotgeom_sf-purrwalk">-
make some visualizations of select variables over time and space using
ggplot::geom_sf purr::walk</h1>
<h1 id="do-one-per-dataset-eg-terraclimate-aet-modis-ndvi-nlcd-land-cover-per-aggregation-level-county-annual-county-monthly-tract-annual-tract-monthly">do
one per dataset (e.g.terraclimate aet, modis ndvi, nlcd land cover) per
aggregation level (county annual, county monthly, tract annual, tract
monthly)</h1>
<h1 id="knit-at-the-end-of-targets">knit at the end of targets</h1>

</body>
</html>
